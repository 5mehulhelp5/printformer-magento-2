define(["jquery","jquery/ui","jquery/jquery.parsequery","Magento_Ui/js/modal/modal","mage/translate","printformerTools"],function(c,b,e,a,d){c.widget("mage.printformer",{options:{qtySelector:"#qty",addBtnSelector:"#product-addtocart-button, #product-updatecart-button",editBtnSelector:"#printformer-edit-button",uploadBtnSelector:"#printformer-upload-button",editorMainSelector:"#printformer-editor-main",editorCloseSelector:"#printformer-editor-close",editorNoticeSelector:"#printformer-editor-notice",variationsFront:[],variations:[]},formatChange:false,getUploadEditorUrl:function(){return this.options.UploadEditorUrl},getEditorUrl:function(){var g=this.options,m=g.urlTemplate.split("?"),f=m[0],i=c(g.qtySelector),l=c('[data-action="add-to-wishlist"]').data("post"),k=c('[name="form_key"]'),j=l.action.split("/"),h="";f+="?";f+=m[1];if(i.val()){f+=encodeURIComponent("qty/"+i.val())}if(k){f+=encodeURIComponent("/form_key/"+k.val())}c.each(j,function(n,o){if(o=="wishlist"||o=="index"){h+=o+"/"}else{if(o=="updateItemOptions"){h+=o}}});f+=encodeURIComponent("?");c.each(l.data,function(n,o){if(n!=="product"&&n!=="qty"&&n!=="uenc"){f+=encodeURIComponent("&"+n+"="+o)}});if(h.length){f+=encodeURIComponent("&updateWishlistItemOptions="+h)}return f},initPersonalisationQty:function(){if(this.options.personalizations>1){var h=c(this.options.qtySelector);c(h).val(this.options.personalizations);if(!c("#personalisation_qty").length){var g=c("<input/>").attr("type","text").attr("class",c(h).attr("class")).attr("id","personalisation_qty").val(this.options.personalizations).prop("disabled",true);c(g).insertAfter(c(h))}c(h).trigger("change").hide();if(!c("#printformer_personalisations").length){var f=c('<input value="'+this.options.personalizations+'" type="hidden" id="printformer_personalisations" name="printformer_personalisations"/>');c(this.options.qtySelector).after(f)}}},_create:function(){this._initEditorMain();this._initAddBtn();this._initEditBtn();this._initUploadBtn();this._initVariations();if(this.options.isConfigure){this.hideSecondButton();this.setPrimaryButton(d("Edit draft"))}var f=this;if(this.options.personalizations>0){this.initPersonalisationQty();c(document).on("printformer_preselect_options_after",function(){f.initPersonalisationQty()})}c(document).trigger("printformer:loaded")},hideSecondButton:function(){if(c(this.uploaBtn).length){c(this.uploaBtn).hide()}},setPrimaryButton:function(j){var i=this.options.draftMasterId;var g=this.options.UploadMasterId;var f="editor";if(i==g){f="upload"}c(this.editBtn).attr("data-pf-masterid",i);c(this.editBtn).attr("data-pf-type",f);if(c(this.editBtn).length){var h=c(this.editBtn).children("span");c(h).text(j)}},_initEditorMain:function(){var f=this.options;this.editorMain=c(f.editorMainSelector);this.editorMain.modal({modalClass:"printformer-editor-main-modal",title:f.productTitle,buttons:[],modalCloseBtnHandler:this.editorCloseOpen.bind(this)});this._initEditorClose();this._initEditorNotice()},editorMainOpen:function(f){c("html, body").css({overflow:"hidden",height:"100%",width:"100%"});this.editorMain.modal("openModal");this.editorMain.html(c('<iframe width="100%" height="100%"/>')).find("iframe").first().attr("src",f)},_initEditorClose:function(){var f=this.options;this.editorClose=c(f.editorCloseSelector);this.editorClose.modal({modalClass:"printformer-editor-close-modal",modalCloseBtnHandler:this.editorCloseCancel.bind(this),buttons:[{text:d("Yes"),"class":"ok-btn",click:this.editorCloseOk.bind(this)},{text:d("No"),"class":"cancel-btn",click:this.editorCloseCancel.bind(this)}]})},editorCloseOpen:function(){this.editorClose.modal("openModal")},editorCloseOk:function(){this.editorMain.modal("closeModal");this.editorClose.modal("closeModal");c("html, body").css({overflow:"auto",height:"auto",width:"auto"});this.editorMain.html("")},editorCloseCancel:function(){this.editorClose.modal("closeModal")},_initEditorNotice:function(){var f=this.options;this.editorNotice=c(f.editorNoticeSelector);if(!this.editorNotice){return}this.editorNotice.modal({modalClass:"printformer-editor-notice-modal",modalCloseBtnHandler:this.editorNoticeCancel.bind(this),buttons:[{text:"OK","class":"ok-btn",click:this.editorNoticeOk.bind(this)},{text:"Cancel","class":"cancel-btn",click:this.editorNoticeCancel.bind(this)}]})},editorNoticeOpen:function(){this.editorNotice.modal("openModal")},editorNoticeOk:function(){this.formatChange=true;this.editorNotice.modal("closeModal")},editorNoticeCancel:function(){this.formatChange=false;this.editorNotice.modal("closeModal");if(!this.formatChange){for(var f in this.options.variationsFront){c("#"+f).val(this.options.variationsFront[f]).trigger("change",{skip:true})}}},setButtonText:function(f,i){var h=c(f).children("span");var g=c(h).children("i");c(h).text(i);if(c(g).length){c(h).text(" "+c(h).text());c(h).prepend(c(g))}},isUploadProduct:function(){return this.options.draftMasterId==this.options.UploadMasterId},_initAddBtn:function(){var f=this.options;this.addBtn=c(f.addBtnSelector);var g=null;if(f.draftId){g=c('<input value="'+f.draftId+'" type="hidden" id="printformer_draftid" name="printformer_draftid"/>');c(f.qtySelector).after(g)}var h=null;if(f.draftMasterId){var i=f.qtySelector;if(g!==null){i=g}var h=c('<input value="'+f.draftMasterId+'" type="hidden" id="printformer_masterid" name="printformer_masterid"/>');c(i).after(h)}if(g!==null&&h!==null&&f.draftId){var k=null;var j=c(".printformer-preselect");c.each(j,function(l,m){if(c(m).data("pf-masterid")==c(h).val()){k=m}});c(g).printformerTools({saveUrl:f.DraftsSaveUrl,currentProduct:f.ProductId}).sessionData().addDraftIdToSession(c(k),f.draftId)}this.addBtnDisable()},addBtnEnable:function(){this.addBtn.prop("disabled",false)},addBtnDisable:function(){var f=this.options;if(!f.allowAddCart){this.addBtn.prop("disabled",true)}},_initEditBtn:function(){var g=this;var f=this.options;this.editBtn=c(this.options.editBtnSelector);this.editBtn.click({printformer:this},function(h){h.data.printformer.editorMainOpen(g.getEditorUrl())}).show();if(f.draftId&&!this.isUploadProduct()){this.setButtonText(c(this.editBtn),d("View draft"))}},editBtnEnable:function(){this.editBtn.prop("disabled",false)},editBtnDisable:function(){this.editBtn.prop("disabled",true)},_initUploadBtn:function(){var g=this;var f=this.options;this.uploaBtn=c(this.options.uploadBtnSelector);this.uploaBtn.click({printformer:this},function(h){h.data.printformer.editorMainOpen(g.getUploadEditorUrl())}).show();if(f.draftId&&this.isUploadProduct()){this.setButtonText(c(this.uploaBtn),d("View upload"))}},uploadBtnEnable:function(){this.uploadBtn.prop("disabled",false)},uploadBtnDisable:function(){c(this.uploadBtn).prop("disabled",true)},_initVariations:function(){var j=this.options.variationsConfig;if(typeof j!=="object"){return}for(var i in j){var h=c("#"+i);if(!h.length){continue}this.editBtnDisable();this.uploadBtnDisable();h.change({printformer:this},function(l,k){if(k){return}l.data.printformer.setVariation(c(this).attr("id"),c(this).val())});for(var g in this.options.variations){if(j[i]["param"]==g){for(var f in j[i]["map"]){if(j[i]["map"][f]==this.options.variations[g]){h.val(f)}}}}h.change()}if(this.options.qty&&c(this.options.qtySelector).prop("tagName")!="SELECT"){c(this.options.qtySelector).val(this.options.qty)}},setVariation:function(i,g){var h=this.options.variationsConfig;if(!i||!h[i]||!h[i]["param"].length){return}if(!this.formatChange&&h[i]["notice"]&&this.options.variationsFront[i]!==undefined&&this.options.variationsFront[i].length){this.editorNotice.modal("openModal");return}this.editBtnEnable();this.uploadBtnEnable();this.options.variationsFront[i]=g;this.options.variations[h[i]["param"]]=h[i]["map"][g];for(var f in this.options.variations){if(this.options.variations[f]===undefined||!this.options.variations[f].length){this.editBtnDisable();this.uploadBtnDisable()}}}});return c.mage.printformer});