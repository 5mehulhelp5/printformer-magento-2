define(["jquery","jquery/ui","jquery/jquery.parsequery","Magento_Ui/js/modal/modal","mage/translate","printformerTools"],function(c,b,f,a,e,d){c.widget("mage.printformer",{options:{qtySelector:"#qty",addBtnSelector:"#product-addtocart-button, #product-updatecart-button",editBtnSelector:"#printformer-edit-button",uploadBtnSelector:"#printformer-upload-button",editorMainSelector:"#printformer-editor-main",editorCloseSelector:"#printformer-editor-close",editorNoticeSelector:"#printformer-editor-notice",variationsFront:[],variations:[]},formatChange:false,getUploadEditorUrl:function(){return this.options.UploadEditorUrl},getEditorUrl:function(){var h=this.options,n=h.urlTemplate.split("?"),g=n[0],j=c(h.qtySelector),m=c('[data-action="add-to-wishlist"]').data("post"),l=c('[name="form_key"]'),k=m.action.split("/"),i="";g+="?";g+=n[1];if(j.val()){g+=encodeURIComponent("qty/"+j.val())}if(l){g+=encodeURIComponent("/form_key/"+l.val())}c.each(k,function(o,p){if(p=="wishlist"||p=="index"){i+=p+"/"}else{if(p=="updateItemOptions"){i+=p}}});g+=encodeURIComponent("?");c.each(m.data,function(o,p){if(o!=="product"&&o!=="qty"&&o!=="uenc"){g+=encodeURIComponent("&"+o+"="+p)}});if(i.length){g+=encodeURIComponent("&updateWishlistItemOptions="+i)}return g},initPersonalisationQty:function(){if(this.options.personalizations>1){var i=c(this.options.qtySelector);c(i).val(this.options.personalizations);if(!c("#personalisation_qty").length){var h=c("<input/>").attr("type","text").attr("class",c(i).attr("class")).attr("id","personalisation_qty").val(this.options.personalizations).prop("disabled",true);c(h).insertAfter(c(i))}c(i).trigger("change").hide();if(!c("#printformer_personalisations").length){var g=c('<input value="'+this.options.personalizations+'" type="hidden" id="printformer_personalisations" name="printformer_personalisations"/>');c(this.options.qtySelector).after(g)}}},_create:function(){this._initEditorMain();this._initAddBtn();this._initEditBtn();this._initUploadBtn();this._initVariations();if(this.options.isConfigure){this.hideSecondButton();this.setPrimaryButton(e("Edit draft"))}var g=this;if(this.options.personalizations>0){this.initPersonalisationQty();c(document).on("printformer_preselect_options_after",function(){g.initPersonalisationQty()})}c(document).trigger("printformer:loaded")},hideSecondButton:function(){if(c(this.uploaBtn).length){c(this.uploaBtn).hide()}},setPrimaryButton:function(k){var j=this.options.draftMasterId;var h=this.options.UploadMasterId;var g="editor";if(j==h){g="upload"}c(this.editBtn).attr("data-pf-masterid",j);c(this.editBtn).attr("data-pf-type",g);if(c(this.editBtn).length){var i=c(this.editBtn).children("span");c(i).text(k)}},_initEditorMain:function(){var g=this.options;this.editorMain=c(g.editorMainSelector);this.editorMain.modal({modalClass:"printformer-editor-main-modal",title:g.productTitle,buttons:[],modalCloseBtnHandler:this.editorCloseOpen.bind(this)});this._initEditorClose();this._initEditorNotice()},editorMainOpen:function(g){c("html, body").css({overflow:"hidden",height:"100%",width:"100%"});this.editorMain.modal("openModal");this.editorMain.html(c('<iframe width="100%" height="100%"/>')).find("iframe").first().attr("src",g)},_initEditorClose:function(){var g=this.options;this.editorClose=c(g.editorCloseSelector);this.editorClose.modal({modalClass:"printformer-editor-close-modal",modalCloseBtnHandler:this.editorCloseCancel.bind(this),buttons:[{text:e("Yes"),"class":"ok-btn",click:this.editorCloseOk.bind(this)},{text:e("No"),"class":"cancel-btn",click:this.editorCloseCancel.bind(this)}]})},editorCloseOpen:function(){this.editorClose.modal("openModal")},editorCloseOk:function(){this.editorMain.modal("closeModal");this.editorClose.modal("closeModal");c("html, body").css({overflow:"auto",height:"auto",width:"auto"});this.editorMain.html("")},editorCloseCancel:function(){this.editorClose.modal("closeModal")},_initEditorNotice:function(){var g=this.options;this.editorNotice=c(g.editorNoticeSelector);if(!this.editorNotice){return}this.editorNotice.modal({modalClass:"printformer-editor-notice-modal",modalCloseBtnHandler:this.editorNoticeCancel.bind(this),buttons:[{text:"OK","class":"ok-btn",click:this.editorNoticeOk.bind(this)},{text:"Cancel","class":"cancel-btn",click:this.editorNoticeCancel.bind(this)}]})},editorNoticeOpen:function(){this.editorNotice.modal("openModal")},editorNoticeOk:function(){this.formatChange=true;this.editorNotice.modal("closeModal")},editorNoticeCancel:function(){this.formatChange=false;this.editorNotice.modal("closeModal");if(!this.formatChange){for(var g in this.options.variationsFront){c("#"+g).val(this.options.variationsFront[g]).trigger("change",{skip:true})}}},setButtonText:function(g,j){var i=c(g).children("span");var h=c(i).children("i");c(i).text(j);if(c(h).length){c(i).text(" "+c(i).text());c(i).prepend(c(h))}},isUploadProduct:function(){return this.options.draftMasterId==this.options.UploadMasterId},_initAddBtn:function(){var g=this.options;this.addBtn=c(g.addBtnSelector);var i=null;if(g.draftId){i=c('<input value="'+g.draftId+'" type="hidden" id="printformer_draftid" name="printformer_draftid"/>');c(g.qtySelector).after(i)}var j=null;if(g.draftMasterId){var k=g.qtySelector;if(i!==null){k=i}var j=c('<input value="'+g.draftMasterId+'" type="hidden" id="printformer_masterid" name="printformer_masterid"/>');c(k).after(j)}if(i!==null&&j!==null&&g.draftId){var m=null;var l=c(".printformer-preselect");c.each(l,function(n,o){if(c(o).data("pf-masterid")==c(j).val()){m=o}});var h=new d(c(i),"session",{saveUrl:g.DraftsSaveUrl,currentProduct:g.ProductId});h.addDraftIdToSession(c(m),g.draftId)}this.addBtnDisable()},addBtnEnable:function(){this.addBtn.prop("disabled",false)},addBtnDisable:function(){var g=this.options;if(!g.allowAddCart){this.addBtn.prop("disabled",true)}},_initEditBtn:function(){var h=this;var g=this.options;this.editBtn=c(this.options.editBtnSelector);this.editBtn.click({printformer:this},function(i){i.data.printformer.editorMainOpen(h.getEditorUrl())}).show();if(g.draftId&&!this.isUploadProduct()){this.setButtonText(c(this.editBtn),e("View draft"))}},editBtnEnable:function(){this.editBtn.prop("disabled",false)},editBtnDisable:function(){this.editBtn.prop("disabled",true)},_initUploadBtn:function(){var h=this;var g=this.options;this.uploaBtn=c(this.options.uploadBtnSelector);this.uploaBtn.click({printformer:this},function(i){i.data.printformer.editorMainOpen(h.getUploadEditorUrl())}).show();if(g.draftId&&this.isUploadProduct()){this.setButtonText(c(this.uploaBtn),e("View upload"))}},uploadBtnEnable:function(){this.uploadBtn.prop("disabled",false)},uploadBtnDisable:function(){c(this.uploadBtn).prop("disabled",true)},_initVariations:function(){var l=this.options.variationsConfig;if(typeof l!=="object"){return}for(var j in l){var i=c("#"+j);if(!i.length){continue}this.editBtnDisable();this.uploadBtnDisable();i.change({printformer:this},function(m,k){if(k){return}m.data.printformer.setVariation(c(this).attr("id"),c(this).val())});for(var h in this.options.variations){if(l[j]["param"]==h){for(var g in l[j]["map"]){if(l[j]["map"][g]==this.options.variations[h]){i.val(g)}}}}i.change()}if(this.options.qty&&c(this.options.qtySelector).prop("tagName")!="SELECT"){c(this.options.qtySelector).val(this.options.qty)}},setVariation:function(j,h){var i=this.options.variationsConfig;if(!j||!i[j]||!i[j]["param"].length){return}if(!this.formatChange&&i[j]["notice"]&&this.options.variationsFront[j]!==undefined&&this.options.variationsFront[j].length){this.editorNotice.modal("openModal");return}this.editBtnEnable();this.uploadBtnEnable();this.options.variationsFront[j]=h;this.options.variations[i[j]["param"]]=i[j]["map"][h];for(var g in this.options.variations){if(this.options.variations[g]===undefined||!this.options.variations[g].length){this.editBtnDisable();this.uploadBtnDisable()}}}});return c.mage.printformer});