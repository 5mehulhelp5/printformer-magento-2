define(["jquery","jquery/ui","jquery/jquery.parsequery","Magento_Ui/js/modal/modal","mage/translate","printformerTools"],function(c,b,f,a,e,d){c.widget("mage.printformer",{options:{qtySelector:"#qty",addBtnSelector:"#product-addtocart-button, #product-updatecart-button",editBtnSelector:"#printformer-edit-button",uploadBtnSelector:"#printformer-upload-button",editorMainSelector:"#printformer-editor-main",editorCloseSelector:"#printformer-editor-close",editorNoticeSelector:"#printformer-editor-notice",variationsFront:[],variations:[]},formatChange:false,currentDrafts:null,getUploadUrl:function(){return this.options.urls.upload},getUploadAndEditorUrl:function(){return this.options.urls.uploadAndEditor},getPersonalizeUrl:function(){return this.options.urls.personalize},getEditorUrl:function(){var h=this.options,n=h.urls.customize.split("?"),g=n[0],j=c(h.qtySelector),m=c('[data-action="add-to-wishlist"]').data("post"),l=c('[name="form_key"]'),i="";var k=undefined;if(m){k=m.action.split("/")}g+="?";g+=n[1];if(j.val()){g+=encodeURIComponent("qty/"+j.val())}if(l){g+=encodeURIComponent("/form_key/"+l.val())}if(k!=undefined){c.each(k,function(o,p){if(p=="wishlist"||p=="index"){i+=p+"/"}else{if(p=="updateItemOptions"){i+=p}}})}g+=encodeURIComponent("?");if(m){c.each(m.data,function(o,p){if(o!=="product"&&o!=="qty"&&o!=="uenc"){g+=encodeURIComponent("&"+o+"="+p)}})}if(i.length){g+=encodeURIComponent("&updateWishlistItemOptions="+i)}return g},initPersonalisationQty:function(){if(this.options.personalizations>1){var i=c(this.options.qtySelector);c(i).val(this.options.personalizations);if(!c("#personalisation_qty").length){var h=c("<input/>").attr("type","text").attr("class",c(i).attr("class")).attr("id","personalisation_qty").val(this.options.personalizations).prop("disabled",true);c(h).insertAfter(c(i))}c(i).trigger("change").hide();if(!c("#printformer_personalisations").length){var g=c('<input value="'+this.options.personalizations+'" type="hidden" id="printformer_personalisations" name="printformer_personalisations"/>');c(this.options.qtySelector).after(g)}}},_create:function(){var g=this;c.ajax({url:g.options.DraftsGetUrl+"product/"+g.options.ProductId+"/",method:"get",dataType:"json"}).done(function(h){g.currentDrafts=h;g._initEditorMain();g._initAddBtn();g._initEditBtn();g._initUploadBtn();g._initVariations();if(g.options.isConfigure){g.hideSecondButton();g.setPrimaryButton(e("Edit draft"))}if(g.options.personalizations>0){g.initPersonalisationQty();c(document).on("printformer_preselect_options_after",function(){g.initPersonalisationQty()})}c(document).trigger("printformer:loaded")})},hideSecondButton:function(){if(c(this.uploaBtn).length){c(this.uploaBtn).hide()}},setPrimaryButton:function(k){var j=this;var h=this.options.currentSessionIntent;var g="editor";if(h=="upload"||h=="upload-and-editor"){g="upload"}c(this.editBtn).attr("data-pf-masterid",this.options.masterId);c(this.editBtn).attr("data-pf-type",g);c(this.editBtn).attr("data-pf-intent",h);if(g=="upload"){c(this.editBtn).unbind("click");c(this.editBtn).click({printformer:this},function(m){var l=h=="upload-and-editor"?j.getUploadAndEditorUrl():j.getUploadUrl();m.data.printformer.editorMainOpen(l)})}if(c(this.editBtn).length){var i=c(this.editBtn).children("span");c(i).text(k)}},_initEditorMain:function(){var g=this.options;this.editorMain=c(g.editorMainSelector);this.editorMain.modal({modalClass:"printformer-editor-main-modal",title:g.productTitle,buttons:[],modalCloseBtnHandler:this.editorCloseOpen.bind(this)});this._initEditorClose();this._initEditorNotice()},editorMainOpen:function(g){c("html, body").css({overflow:"hidden",height:"100%",width:"100%"});this.editorMain.modal("openModal");this.editorMain.html(c('<iframe width="100%" height="100%"/>')).find("iframe").first().attr("src",g)},_initEditorClose:function(){var g=this.options;this.editorClose=c(g.editorCloseSelector);this.editorClose.modal({modalClass:"printformer-editor-close-modal",modalCloseBtnHandler:this.editorCloseCancel.bind(this),buttons:[{text:e("Yes"),"class":"ok-btn",click:this.editorCloseOk.bind(this)},{text:e("No"),"class":"cancel-btn",click:this.editorCloseCancel.bind(this)}]})},editorCloseOpen:function(){this.editorClose.modal("openModal")},editorCloseOk:function(){this.editorMain.modal("closeModal");this.editorClose.modal("closeModal");c("html, body").css({overflow:"auto",height:"auto",width:"auto"});this.editorMain.html("")},editorCloseCancel:function(){this.editorClose.modal("closeModal")},_initEditorNotice:function(){var g=this.options;this.editorNotice=c(g.editorNoticeSelector);if(!this.editorNotice){return}this.editorNotice.modal({modalClass:"printformer-editor-notice-modal",modalCloseBtnHandler:this.editorNoticeCancel.bind(this),buttons:[{text:"OK","class":"ok-btn",click:this.editorNoticeOk.bind(this)},{text:"Cancel","class":"cancel-btn",click:this.editorNoticeCancel.bind(this)}]})},editorNoticeOpen:function(){this.editorNotice.modal("openModal")},editorNoticeOk:function(){this.formatChange=true;this.editorNotice.modal("closeModal")},editorNoticeCancel:function(){this.formatChange=false;this.editorNotice.modal("closeModal");if(!this.formatChange){for(var g in this.options.variationsFront){c("#"+g).val(this.options.variationsFront[g]).trigger("change",{skip:true})}}},setButtonText:function(g,j){var i=c(g).children("span");var h=c(i).children("i");c(i).text(j);if(c(h).length){c(i).text(" "+c(i).text());c(i).prepend(c(h))}},isUploadProduct:function(){return(this.options.currentSessionIntent=="upload-and-editor"||this.options.currentSessionIntent=="upload")},_initAddBtn:function(){var g=this.options;this.addBtn=c(g.addBtnSelector);var h=null;if(g.draftId){h=c('<input value="'+g.draftId+'" type="hidden" id="printformer_draftid" name="printformer_draftid"/>');c(g.qtySelector).after(h)}var j=null;if(h&&g.intent){j=c('<input value="'+g.intent+'" type="hidden" id="printformer_intent" name="printformer_intent"/>');c(h).after(j)}var i=null;if(h&&j&&g.unique_id){i=c('<input value="'+g.unique_id+'" type="hidden" id="printformer_unique_session_id" name="printformer_unique_session_id"/>');c(j).after(i)}this.addBtnDisable()},addBtnEnable:function(){this.addBtn.prop("disabled",false)},addBtnDisable:function(){var g=this.options;if(!g.allowAddCart){this.addBtn.prop("disabled",true)}},_initEditBtn:function(){var h=this;var g=this.options;this.editBtn=c(this.options.editBtnSelector);this.editBtn.click({printformer:this},function(j){j.data.printformer.editorMainOpen(h.getEditorUrl())}).show();var i=false;if(this.currentDrafts){if(typeof this.currentDrafts.customize!=typeof undefined){i=true}else{if(typeof this.currentDrafts.personalize!=typeof undefined){i=true}}}if(i){this.setButtonText(c(this.editBtn),e("View draft"))}},editBtnEnable:function(){this.editBtn.prop("disabled",false)},editBtnDisable:function(){this.editBtn.prop("disabled",true)},_initUploadBtn:function(){var k=this;var i=this.options;this.uploaBtn=c(this.options.uploadBtnSelector);var g=false;var h=k.getUploadUrl();if(c(k.uploaBtn).data("pf-intent")=="upload-and-editor"){var h=k.getUploadAndEditorUrl();g=true}this.uploaBtn.click({printformer:this},function(m){m.data.printformer.editorMainOpen(h)}).show();var j=(g?"upload-and-editor":"upload");var l=false;if(this.currentDrafts&&typeof this.currentDrafts[j]!=typeof undefined){l=true}if(l){this.setButtonText(c(this.uploaBtn),e("View upload"))}},uploadBtnEnable:function(){this.uploadBtn.prop("disabled",false)},uploadBtnDisable:function(){c(this.uploadBtn).prop("disabled",true)},_initVariations:function(){var l=this.options.variationsConfig;if(typeof l!=="object"){return}for(var j in l){var i=c("#"+j);if(!i.length){continue}this.editBtnDisable();this.uploadBtnDisable();i.change({printformer:this},function(m,k){if(k){return}m.data.printformer.setVariation(c(this).attr("id"),c(this).val())});for(var h in this.options.variations){if(l[j]["param"]==h){for(var g in l[j]["map"]){if(l[j]["map"][g]==this.options.variations[h]){i.val(g)}}}}i.change()}if(this.options.qty&&c(this.options.qtySelector).prop("tagName")!="SELECT"){c(this.options.qtySelector).val(this.options.qty)}},setVariation:function(j,h){var i=this.options.variationsConfig;if(!j||!i[j]||!i[j]["param"].length){return}if(!this.formatChange&&i[j]["notice"]&&this.options.variationsFront[j]!==undefined&&this.options.variationsFront[j].length){this.editorNotice.modal("openModal");return}this.editBtnEnable();this.uploadBtnEnable();this.options.variationsFront[j]=h;this.options.variations[i[j]["param"]]=i[j]["map"][h];for(var g in this.options.variations){if(this.options.variations[g]===undefined||!this.options.variations[g].length){this.editBtnDisable();this.uploadBtnDisable()}}}});return c.mage.printformer});